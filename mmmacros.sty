
% requires extpfeil package
\newextarrow{\injectc}{5599}{\succ\relbar\rightarrow}

\usetikzlibrary{calc,decorations.pathmorphing,shapes}

\newcounter{sarrow}
\newcommand\xrsquigarrow[1]{%
\stepcounter{sarrow}%
\mathrel{\begin{tikzpicture}[baseline= {( $ (current bounding box.south) + (0,-0.5ex) $ )}]
\node[inner sep=.5ex] (\thesarrow) {$\scriptstyle #1$};
\path[draw,<-,decorate,
  decoration={zigzag,amplitude=0.7pt,segment length=1.2mm,pre=lineto,pre length=4pt}] 
    (\thesarrow.south east) -- (\thesarrow.south west);
\end{tikzpicture}}%
}

\newenvironment{importantthm}[1][]{\textbf{Theorem~\refstepcounter{theoremcounter}~(#1).~}\begin{scontents}[store-env=buffer]}{\end{scontents}\getstored{buffer}\medskip}

\newcommand*{\incompleteproofname}{Proof}
\newenvironment{incompleteproof}[1][\incompleteproofname]{\begin{proof}[#1]\renewcommand*{\qedsymbol}{\fbox{trust me, bro}}}{\end{proof}}


\newcommand{\mi}[1]{\ensuremath{\mathit{#1}}}
\newcommand{\mr}[1]{\ensuremath{\mathrm{#1}}}
\newcommand{\mt}[1]{\ensuremath{\texttt{#1}}}
\newcommand{\mtt}[1]{\ensuremath{\mathtt{#1}}}
\newcommand{\mf}[1]{\ensuremath{\mathbf{#1}}}
\newcommand{\mk}[1]{\ensuremath{\mathfrak{#1}}}
\newcommand{\mc}[1]{\ensuremath{\mathcal{#1}}}
\newcommand{\ms}[1]{\ensuremath{\mathsf{#1}}}
\newcommand{\mb}[1]{\ensuremath{\mathbb{#1}}}
\newcommand{\msc}[1]{\ensuremath{\mathscr{#1}}}

%\newcommand{\myfig}[3]{\begin{figure} [!ht]
%#1
%\caption{\label{fig:#2}#3}
%\end{figure}}
\newcounter{pseudofigcounter}
\crefalias{pseudofig}{pseudofigcounter}
\crefname{pseudofig}{Figure}{Figures}
\newcommand{\myfig}[3]{%
  \noindent
  \begin{minipage}{\textwidth}
    \begin{center}
      \fbox{\begin{minipage}{\textwidth}
        \begin{center}
          #1
        \end{center}
      \end{minipage}}
      $\;$\\
    \parbox{\textwidth}{Figure \refstepcounter{pseudofigcounter}\thepseudofigcounter:\label[pseudofig]{fig:#2} #3}
    \end{center}
  \end{minipage}
  $\;$\\
}

\newcommand{\textgraybox}[1]{\boxed{#1}}
\newdimen\zzfontsz
\newcommand{\fontsz}[2]{\zzfontsz=#1%
{\fontsize{\zzfontsz}{1.2\zzfontsz}\selectfont{#2}}}
\newcommand{\mathsz}[2]{\text{\fontsz{#1}{$#2$}}}
\newcommand{\instsymColon}{%
     \raisebox{-0.09ex}{\text{\normalfont{:}}}}
\newcommand{\judgboxfontsize}[1]{%
        \mathsz{11pt}{#1}%
}
\newcommand{\judgbox}[2]{%
      {\raggedright \textgraybox{\ensuremath{\judgboxfontsize{#1}}}\!%
        \fontsz{9pt}{\begin{tabular}[c]{l} #2 \end{tabular}} %
}}
\newcounter{typerule}
\crefname{typerule}{rule}{rules}

\newcommand{\typeruleInt}[5]{%
	\def\thetyperule{#1}%
	\refstepcounter{typerule}%
	\label{tr:#4}%
	%
  \ensuremath{\begin{array}{c}#5 \inference{#2}{#3}\end{array}}
}
\newcommand{\typerule}[4]{%
  \typeruleInt{#1}{#2}{#3}{#4}{\textsf{\scriptsize ({#1})} \\      }
}
\newcommand{\typerulenolabel}[3]{%
	\def\thetyperule{#1}%
	\refstepcounter{typerule}%
  \ensuremath{\begin{array}{c} \inference{#2}{#3}\end{array}}
}
\newcommand{\typerulederiv}[3]{%
  \ensuremath{\begin{array}{c} \inference{#2}{#3} #1\end{array}}
}

\newcommand{\nat}[0]{\ensuremath{\mb{N}}\xspace}
\newcommand{\arr}[0]{\ensuremath{\mb{A}}\xspace}

\newcommand\bnfdef{\ensuremath{\mathrel{::=}}}

\newcommand{\hole}[1]{\ensuremath{\left[#1\right]}}

\newcommand{\Gammas}[0]{\src{\Gamma}\xspace}
\newcommand{\Deltas}[0]{\src{\Delta}\xspace}
\newcommand{\Deltat}[0]{\trg{\Delta}\xspace}


\newcommand{\propositions}{\ensuremath\bm{P}}
\newcommand{\powerset}[1]{\mathscr{P}\left({#1}\right)}

\newcommand{\partials}{\ensuremath\mathcal{P}}
\newcommand{\wholes}{\ensuremath\mathcal{W}}
\newcommand{\wellf}{\vdash_{\text{\tiny W}}}
\newcommand{\singlestep}{\stackrel{e}{\hookrightarrow}}
\newcommand{\linker}{\mathrel\blacktriangleright\joinrel\mathrel\blacktriangleleft}

\newcommand{\emptyevent}{\varepsilon}
\newcommand{\terminationevent}{\lightning}
\newcommand{\estep}[3]{{#1}\stackrel{#2}{\hookrightarrow}{#3}}
\newcommand{\step}[2]{{#1}\hookrightarrow{#2}}

\newcommand{\terminates}[1]{{#1}\Downarrow}

\newcommand{\seqnil}{\cdot}
\newcommand{\seqcons}[2]{{{#1}:{\kern-6.25pt}:{#2}}}

\newcommand{\valueexpr}{v}
\newcommand{\finalexprnoerr}{f}
\newcommand{\finalexpr}{f_{\lightning}}
\newcommand{\type}{\tau}
\newcommand{\types}{\src{\type}}
\newcommand{\events}{E\cup\{\lightning\}}
\newcommand{\behav}[1]{\text{Behav}({#1})}
\newcommand{\event}[1][]{a#1}
\newcommand{\absevent}[1][]{\bm{a}#1}
\newcommand{\trace}[1][]{\overline{a#1}}
\newcommand{\abstrace}[1][]{\bm{\overline{a}}#1}
\newcommand{\mstrace}[1][]{\overline{a^{\text{\tiny ms}}#1}}
\newcommand{\msevent}[1][]{a^{\text{\tiny ms}}#1}
\newcommand{\mktrace}[2]{{#1}\leadsto{#2}}
\newcommand{\prop}{\pi}
\newcommand{\traces}{\text{Traces}}
\newcommand{\lift}[1]{\left\lceil{#1}\right\rceil}
\newcommand{\policy}{\text{Policy}}

\newcommand{\abstermination}{\lightning{\kern-5.7pt}\lightning}

\newcommand{\fresh}[2]{{#1}\vdash {#2}\ \textit{fresh}\xspace}

\newcommand{\loweq}[2]{{#1}=_L{#2}}
\newcommand{\selfcompo}[2]{{#1}\thicksim{#2}}

\newcommand{\classcollapse}{\star}
\newcommand{\collapse}[1]{{#1}^{\classcollapse}}
\newcommand{\class}[1]{\mathbb{#1}}
\newcommand{\cC}{\class{C}}
\newcommand{\cSafety}{\text{Safety}}
\newcommand{\cHSafety}{\text{HyperSafety}}
\newcommand{\cTwoHSafety}{\text{2-HyperSafety}}
\newcommand{\cKHSafety}{\text{K-HyperSafety}}
\newcommand{\cSS}{\text{SSC}}
\newcommand{\mutex}{\text{MutEx}}
\newcommand{\nonterm}{\text{Nontermination}}
\newcommand{\determ}{\text{Determinism}}
\renewcommand{\ss}{\text{SS}}
\newcommand{\rss}{\text{RSS}}
\newcommand{\Ni}{\text{NI}}
\newcommand{\RNi}{\text{RNI}}
\newcommand{\nvOne}{\text{No-v1}}
\newcommand{\nvFour}{\text{No-v4}}
\newcommand{\nvOneFour}{\text{No-v1-v4}}

\newcommand{\fccomp}[2]{{#1}\overset{\bullet}{\cap}{#2}}
\newcommand{\fcleq}[2]{{#1}\overset{\bullet}{\subseteq}{#2}}

\newcommand{\sat}[2]{{#1}\vDash{#2}}
\newcommand{\nsat}[2]{{#1}\not\vDash{#2}}
\newcommand{\rsat}[2]{{#1}\vDash_{\scriptstyle R}{#2}}
\newcommand{\nrsat}[2]{{#1}\not\vDash_{\scriptstyle R}{#2}}
\newcommand{\instr}[2]{{#1}\injectc[]{}{#2}}
\newcommand{\sinstr}[3]{{#1}\injectc[]{#2}{#3}}

\newcommand{\neutcol}[0]{black}
\newcommand{\stlccol}[0]{RoyalBlue}
\newcommand{\irccol}[0]{Apricot}
\newcommand{\ulccol}[0]{RedOrange}
\newcommand{\objcol}[0]{CarnationPink}
\newcommand{\commoncol}[0]{black}

\newcommand{\col}[2]{\ensuremath{{\color{#1}{#2}}}}

\newcommand{\com}[1]{\ensuremath\mathit{\col{\neutcol}{#1}}}
\newcommand{\src}[1]{\ensuremath\mathsf{\col{\stlccol}{#1}}}
\newcommand{\irl}[1]{\ensuremath\mathit{\col{\irccol}{#1}}}
\newcommand{\trg}[1]{\ensuremath\mathbf{\col{\ulccol}{#1}}}
\newcommand{\obj}[1]{\ensuremath\mathtt{\col{\objcol}{#1}}}
\renewcommand{\S}{\src{S}}
\newcommand{\I}{\irl{I}}
\newcommand{\T}{\trg{T}}
\renewcommand{\O}{\obj{O}}


\newcommand{\full}{\src{1}}
\newcommand{\half}{\src{\sfrac{1}{2}}}
\newcommand{\ptr}{\src{ref_\full\ \nat}}
\newcommand{\wptr}{\src{ref_\half\ \nat}}
\newcommand{\poison}{\rho}
\newcommand{\poisoned}{\text{\Biohazard}}
\newcommand{\poisonless}{\square}

\newcommand{\specificev}[1]{\underline{#1}}
\newcommand{\specificevs}[1]{\src{\underline{#1}}}
\newcommand{\specificevt}[1]{\trg{\underline{#1}}}
\newcommand{\thetospecificfilter}{\theta}
\newcommand{\tospecificev}[1]{\thetospecificfilter\left({#1}\right)}
\newcommand{\tospecificevs}[2][]{\thetospecificfilter#1\left(\src{#2}\right)}
\newcommand{\tospecificevt}[1]{\thetospecificfilter\left(\trg{#1}\right)}
\newcommand{\tospecificevctx}[1]{\thetospecificfilter_{\text{ctx}}\left({#1}\right)}
\newcommand{\tospecificevctxs}[1]{\thetospecificfilter_{\text{ctx}}\left(\src{#1}\right)}
\newcommand{\tospecificevctxt}[1]{\thetospecificfilter_{\text{ctx}}\left(\trg{#1}\right)}
\newcommand{\tospecificevcomps}[1]{\thetospecificfilter_{p}\left(\src{#1}\right)}
\newcommand{\tospecificevcompt}[1]{\thetospecificfilter_{p}\left(\trg{#1}\right)}


\newcommand{\tenc}[1]{\trg{\lfloor} {#1} \trg{\rfloor}}
\newcommand{\stinterp}{\trg{\mathbb{i}}^{\S}}
\newcommand{\ttspec}[1]{\trg{\llbracket{#1}\rrbracket}^{\T\to\T}}
% Different compilers; color automatically applied
\newcommand{\stcomp}[1]{\llbracket\src{#1}\rrbracket^{\S\to\T}}
\newcommand{\sicomp}[1]{\llbracket\src{#1}\rrbracket^{\S\to\I}}
\newcommand{\itcomp}[1]{\llbracket\irl{#1}\rrbracket^{\I\to\T}}
\newcommand{\ttcomp}[1]{\llbracket\trg{#1}\rrbracket^{\T\to\T}}

\newcommand{\sitcomp}[1]{\llbracket\src{#1}\rrbracket^{\S\to\I\to\T}}
\newcommand{\uhcsitcomp}[1]{\llbracket{#1}\rrbracket^{\S+\I\to\T}}
\newcommand{\lhcsitcomp}[1]{\llbracket\src{#1}\rrbracket^{\S\to\I+\T}}
\newcommand{\lhcsiocomp}[1]{\llbracket\src{#1}\rrbracket^{\S\to\I+\O}}
\newcommand{\uhciotcomp}[1]{\llbracket{#1}\rrbracket^{\I+\O\to\T}}
% same compilers, but color not automatically applied
\newcommand{\stcompN}[1]{\llbracket{#1}\rrbracket^{\S\to\T}}
\newcommand{\sicompN}[1]{\llbracket{#1}\rrbracket^{\S\to\I}}
\newcommand{\itcompN}[1]{\llbracket{#1}\rrbracket^{\I\to\T}}
\newcommand{\ttcompN}[1]{\llbracket{#1}\rrbracket^{\T\to\T}}


\newcommand{\thexlangtraceeq}[1][\delta]{\approxeq^*_{#1}\xspace}
\newcommand{\thexlangeventeq}[1][\delta]{\approxeq_{#1}\xspace}
\newcommand{\xlangeventeq}[3][\delta]{\src{#2}\thexlangeventeq[#1]\trg{#3}\xspace}
\newcommand{\xlangtraceeq}[3][\delta]{\src{#2}\thexlangtraceeq[#1]\trg{#3}\xspace}
\newcommand{\xlangtraceneq}[3][\delta]{\src{#2}\not\thexlangtraceeq[#1]\trg{#3}\xspace}
\newcommand{\xlangtraceeqn}[3][\delta]{{#2}\thexlangtraceeq[#1]{#3}\xspace}

\newcommand{\thexlangstateeq}[1][\delta]{\approx_{#1}\xspace}
\newcommand{\xlangstateeq}[3][\delta]{\src{#2}\thexlangstateeq[#1]\trg{#3}\xspace}
\newcommand{\xlangstateneq}[3][\delta]{\src{#2}\not\thexlangstateeq[#1]\trg{#3}\xspace}
\newcommand{\thexlangbackstateeq}[1][\delta]{\multimap_{#1}\xspace}
\newcommand{\xlangbackstateeq}[3][\delta]{\trg{#2}\thexlangbackstateeq[#1]\src{#3}\xspace}

\newcommand{\mmlAmmlAtcomp}[1]{\llbracket\src{#1}\rrbracket^{\mmlAs\to\mmlAt}\xspace}
\newcommand{\mmlAmmlAtcompN}[1]{\llbracket{#1}\rrbracket^{\mmlAs\to\mmlAt}\xspace}

\newcommand{\varmapbacktransds}{\texttt{VarMap}\xspace}

\newcommand{\mmlAmmlAtback}[2][\Game]{\langle{\kern-1.5pt}\langle{\kern-1.5pt}\langle\trg{#2}\rangle{\kern-1.5pt}\rangle{\kern-1.5pt}\rangle^{\mmlAt\to\mmlAs}_{#1}\xspace}
\newcommand{\mmlAmmlAtbackdetail}[2][\Game]{\ensuremath\langle{\kern-1.5pt}\langle\trg{#2}\rangle{\kern-1.5pt}\rangle_{#1}^{\mmlAt\to\mmlAs}\xspace}
\newcommand{\mmlAmmlAtbackdetailz}[1]{\trg{\theta^\diamond}\trg{(#1)}\xspace}
\newcommand{\mmlAmmlAtbackdetailo}[1]{\trg{\theta}\trg{(#1)}\xspace}
\newcommand{\mmlAmmlAtbackv}[1]{\langle{\kern-1.5pt}\langle{\kern-1.5pt}\langle\trg{#1}\rangle{\kern-1.5pt}\rangle{\kern-1.5pt}\rangle{\kern-1.5pt}_v^{\mmlAt\to\mmlAs}\xspace}

% compiler robustly preserves
\newcommand{\rtp}[2]{\vdash{#1}:{#2}}


% concrete language definitions
\newcommand{\mmlA}{\ensuremath\mathtt{L}_\arr\xspace}
\newcommand{\mmlAs}{\src{\mmlA^S}}
\newcommand{\mmlAt}{\trg{\mmlA^T}}
\newcommand{\loc}{\ell}
\newcommand{\configs}{\src{\Omega}}
\newcommand{\qconfig}[1][\diamond]{\Omega^{#1}}
\newcommand{\qconfigs}[1][\diamond]{\src{\Omega^{#1}}}
\newcommand{\configt}{\trg{\Omega}}
\newcommand{\qconfigt}[1][\diamond]{\trg{\Omega^{#1}}}
\newcommand{\config}[2]{{#1};{#2}\xspace}
\newcommand{\sconfig}[2]{\config{\src{#1}}{\src{#2}}}
\newcommand{\tconfig}[2]{\config{\trg{#1}}{\trg{#2}}}

\newcommand{\subst}[3]{{#1}[{#2}\hookrightarrow{#3}]\xspace}
\newcommand{\grow}[2]{{#1}\ll{#2}\xspace}
\newcommand{\grows}[2]{\grow{\src{#1}}{\src{#2}}}

\newcommand{\noptr}[1]{\text{NoOwnedPtr}\ {#1}}
\newcommand{\ctxtocomp}{\xspace ! \xspace}
\newcommand{\comptoctx}{\xspace ? \xspace}
\newcommand{\nocomm}{\xspace \varnothing \xspace}
\newcommand{\comm}{\xspace ?{\kern-1.5pt}! \xspace}
\newcommand{\commlib}{\xspace\xi\xspace}
\newcommand{\callstack}{\xspace \overline{F^c}\xspace}
\newcommand{\memstate}{\xspace \Psi \xspace}
\newcommand{\cfstate}{\xspace \Phi \xspace}

\newcommand{\monitorcheck}[4][{\kern-3.5pt}^*]{%
  \vdash\xspace{#2}\xspace \xrsquigarrow{#4}{#1}\xspace{#3}\xspace%
}
\newcommand{\traceagree}[3][\delta]{\xspace{#2}\xspace \cong_{#1}\xspace{#3}\xspace}
\newcommand{\tmstraceagree}[3][]{\xspace{#2}\xspace \cong#1\xspace{#3}\xspace}
\newcommand{\smstraceagree}[3][]{\xspace{#2}\xspace \cong#1\xspace{#3}\xspace}
\newcommand{\storeagree}[3][\delta]{\xspace{#2}\xspace \simeq_{#1}\xspace{#3}\xspace}
\newcommand{\storeagreetms}[3][\delta_{MS}]{\storeagree[#1]{#2}{#3}}
\newcommand{\storeagreesms}[3][\delta]{\xspace{#2}\xspace \simeq_{#1_{\text{sms}}}\xspace{#3}\xspace}
\newcommand{\tmsmonitor}[1][]{\xspace T_{\text{TMS}}{#1}\xspace}
\newcommand{\smsmonitor}[1][]{\xspace T_{\text{SMS}}{#1}\xspace}
\newcommand{\typecheck}[3]{{#1}\xspace \vdash\xspace {#2} :\ {#3}\xspace}
\newcommand{\typechecks}[3]{\typecheck{\src{#1}}{\src{#2}}{\src{#3}}}
\newcommand{\hasholes}[3]{\xspace\vdash\xspace\src{#2}\xspace\ni_1\src{hole:({#1})\to{#3}}\xspace}
\newcommand{\hasholet}[2]{\xspace\vdash\xspace\trg{#2}\xspace\ni_1\trg{hole:#1}\xspace}
\newcommand{\asymbol}{\xspace F\xspace}
\newcommand{\kontstack}{\xspace\overline{K}\xspace}
\newcommand{\library}{\xspace\Xi\xspace}
\newcommand{\plug}[3]{\xspace\operatorname{fill}_{#1} {#2}\xspace\operatorname{in}{#3}\xspace}
\newcommand{\plugs}[3][Q]{\plug{#1}{\src{#2}}{\src{#3}}}
\newcommand{\plugt}[3][Q]{\plug{#1}{\trg{#2}}{\trg{#3}}}
\newcommand{\closed}[2]{\xspace\left\{{#1}\right\}\vdash_\copyright{#2}\xspace}
\newcommand{\eval}[3]{{#1}\xspace\xrightarrow{#2}\xspace{#3}\xspace}
\newcommand{\evals}[3]{\src{\eval{#1}{#2}{#3}}}
\newcommand{\ctxeval}[3]{{#1}\xspace\xrightarrow{#2}_{ctx}\xspace{#3}\xspace}
\newcommand{\ctxevals}[3]{\src{\ctxeval{#1}{#2}{#3}}}
\newcommand{\expreval}[5]{{#1}\triangleright\xspace {#2}\xrightarrow{#5}\ {#3}\triangleright\xspace {#4}\xspace}
\newcommand{\exprevals}[5]{\expreval{\src{#1}}{\src{#2}}{\src{#3}}{\src{#4}}{\src{#5}}}
\newcommand{\exprevalt}[5]{\expreval{\trg{#1}}{\trg{#2}}{\trg{#3}}{\trg{#4}}{\trg{#5}}}
\newcommand{\exec}[6][{\kern-11.5pt}^*\ \ ]{{#2}\triangleright\xspace {#3}\xrightarrow{#6}{}{\kern-3.5pt}_{\text{ctx}}\xspace{#1}\;\xspace{#4}\triangleright\xspace {#5}\xspace}
\newcommand{\execs}[6][{\kern-11.5pt}^*\ \ ]{\exec[#1]{\src{#2}}{\src{#3}}{\src{#4}}{\src{#5}}{\src{#6}}}
\newcommand{\exect}[6][{\kern-11.5pt}^*\ \ ]{\exec[#1]{\trg{#2}}{\trg{#3}}{\trg{#4}}{\trg{#5}}{\trg{#6}}}
\newcommand{\wexec}[4]{{#1}\xspace\xRightarrow{#4}\xspace{#2}\xspace\triangleright\xspace{#3}\xspace}
\newcommand{\wexecs}[4]{\wexec{\src{#1}}{\src{#2}}{\src{#3}}{\src{#4}}}
\newcommand{\wexect}[4]{\wexec{\trg{#1}}{\trg{#2}}{\trg{#3}}{\trg{#4}}}

% the following environments require the enumitem package
\crefalias{ass}{enumi}
\crefalias{goal}{enumi}
\crefname{ass}{assumption}{assumptions}
\crefname{goal}{goal}{goals}
\newenvironment{assumptions}
    {\begin{enumerate}[label=(\alph*)]
    }
    {
    \end{enumerate}
  }
\newenvironment{goals}
    {\begin{enumerate}[label=(\roman*)]
    }
    {
    \end{enumerate}
  }

\newcommand{\IH}[1][]{I{\kern-1.5pt}H#1}
\newenvironment{passumptions}[1]
  {%
  \begin{enumerate}[label={$\left(#1_{\arabic*}\right)$}]%
  }
  {%
  \end{enumerate}%
  }
\newcommand{\thmref}[1]{\cref{#1}~(\nameref{#1})}
\newcommand{\Thmref}[1]{\Cref{#1}~(\nameref{#1})}
\newenvironment{thmstate}[1]{\noindent\textbf{Statement of \Cref{#1}}~(\nameref{#1})\textbf{.}}{\medskip}
\newcommand{\mockthm}[2]{\begin{thmstate}{#1}\getstored[#2]{buffer}\end{thmstate}}
\newcommand{\realthm}[3]{\begin{theorem}[#3]\label{#1}\getstored[#2]{buffer}\end{theorem}}
