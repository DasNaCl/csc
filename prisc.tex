%% For double-blind review submission, w/o CCS and ACM Reference (max submission space)
%\documentclass[sigplan,review,anonymous]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For double-blind review submission, w/ CCS and ACM Reference
%\documentclass[sigplan,review,anonymous]{acmart}\settopmatter{printfolios=true}
%% For single-blind review submission, w/o CCS and ACM Reference (max submission space)
%\documentclass[sigplan,review]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For single-blind review submission, w/ CCS and ACM Reference
%\documentclass[sigplan,review]{acmart}\settopmatter{printfolios=true}
%% For final camera-ready submission, w/ required CCS and ACM Reference
\documentclass[sigplan,dvipsnames]{acmart}\settopmatter{}
%% "not anonymous"
\settopmatter{printacmref=false} % Removes citation information below abstract
\renewcommand\footnotetextcopyrightpermission[1]{}

%% Conference information
%% Supplied to authors by publisher for camera-ready submission;
%% use defaults for review submission.
\acmConference[PriSC'22]{ACM SIGPLAN Workshop on Principles of Secure Compilation}{January 22nd, 2022}{Philadelphia, PA, USA}
\acmYear{2022}
%\acmISBN{} % \acmISBN{978-x-xxxx-xxxx-x/YY/MM}
%\acmDOI{} % \acmDOI{10.1145/nnnnnnn.nnnnnnn}
%\startPage{1} 

%% Copyright information
%% Supplied to authors (based on authors' rights management selection;
%% see authors.acm.org) by publisher for camera-ready submission;
%% use 'none' for review submission.
\setcopyright{none}
%\setcopyright{acmcopyright}
%\setcopyright{acmlicensed}
%\setcopyright{rightsretained}
%\copyrightyear{2022}           %% If different from \acmYear

%% Bibliography style
\bibliographystyle{ACM-Reference-Format}
%% Citation style
%\citestyle{acmauthoryear}  %% For author/year citations
%\citestyle{acmnumeric}     %% For numeric citations
%\setcitestyle{nosort}      %% With 'acmnumeric', to disable automatic
                            %% sorting of references within a single citation;
                            %% e.g., \cite{Smith99,Carpenter05,Baker12}
                            %% rendered as [14,5,2] rather than [2,5,14].
%\setcitesyle{nocompress}   %% With 'acmnumeric', to disable automatic
                            %% compression of sequential references within a
                            %% single citation;
                            %% e.g., \cite{Baker12,Baker14,Baker16}
                            %% rendered as [2,3,4] rather than [2-4].


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Note: Authors migrating a paper from traditional SIGPLAN
%% proceedings format to PACMPL format must update the
%% '\documentclass' and topmatter commands above; see
%% 'acmart-pacmpl-template.tex'.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand\hmmax{0}
\newcommand\bmmax{0}

%% Some recommended packages.
\usepackage[colorinlistoftodos]{todonotes}
\newcommand{\MK}[1]{\todo[color=orange!30]{TODO: #1}}
\newcommand{\MP}[1]{\todo[color=blue!30]{TODO: #1}}

\usepackage{booktabs}   %% For formal tables:
                        %% http://ctan.org/pkg/booktabs
\usepackage{subcaption} %% For complex figures with subfigures/subcaptions
                        %% http://ctan.org/pkg/subcaption
\usepackage{stmaryrd}
\usepackage{mathrsfs}
\usepackage{mathtools}
\usepackage{xcolor}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{bm}
\usepackage{cleveref}
\usepackage{listings}
\usepackage{./../mmmacros}
\usepackage[switch]{lineno}
%\modulolinenumbers[2]
\renewcommand{\linenumberfont}{\normalfont\bfseries\small\color{red}}

\begin{document}

%% Title information
\title{Composing Compilers}         %% [Short Title] is optional;
                                        %% when present, will be used in
                                        %% header instead of Full Title.
%\titlenote{with title note}             %% \titlenote is optional;
                                        %% can be repeated if necessary;
                                        %% contents suppressed with 'anonymous'
%\subtitle{Subtitle}                     %% \subtitle is optional
%\subtitlenote{with subtitle note}       %% \subtitlenote is optional;
                                        %% can be repeated if necessary;
                                        %% contents suppressed with 'anonymous'


%% Author information
%% Contents and number of authors suppressed with 'anonymous'.
%% Each author should be introduced by \author, followed by
%% \authornote (optional), \orcid (optional), \affiliation, and
%% \email.
%% An author may have multiple affiliations and/or emails; repeat the
%% appropriate command.
%% Many elements are not rendered, but should be provided for metadata
%% extraction tools.

%% Author with single affiliation.
\author{Matthis Kruse}
%\authornote{with author1 note}          %% \authornote is optional;
                                        %% can be repeated if necessary
\orcid{0000-0003-4062-9666}             %% \orcid is optional
\affiliation{
%  \position{Position1}
%  \department{Department1}              %% \department is recommended
  \institution{CISPA Helmholtz Center for Information Security}            %% \institution is required
%  \streetaddress{Street1 Address1}
%  \city{City1}
%  \state{State1}
%  \postcode{Post-Code1}
  \country{Germany}                    %% \country is recommended
}
\email{matthis.kruse@cispa.de}          %% \email is recommended

%% Author with two affiliations and emails.
\author{Marco Patrignani}
%\authornote{with author2 note}          %% \authornote is optional;
                                        %% can be repeated if necessary
\orcid{0000-0003-3411-9678}             %% \orcid is optional
\affiliation{
%  \position{Position2a}
%  \department{Department2a}             %% \department is recommended
  \institution{CISPA Helmholtz Center for Information Security}            %% \institution is required
%  \streetaddress{Street2a Address2a}
%  \city{City2a}
%  \state{State2a}
%  \postcode{Post-Code2a}
  \country{Germany}                   %% \country is recommended
}
\email{marco.patrignani@cispa.de}         %% \email is recommended

%% Abstract
%% Note: \begin{abstract}...\end{abstract} environment must come
%% before \maketitle command
%\begin{abstract}
%Text of abstract \ldots.
%\end{abstract}


%% 2012 ACM Computing Classification System (CSS) concepts
%% Generate at 'http://dl.acm.org/ccs/ccs.cfm'.
%\begin{CCSXML}
%<ccs2012>
%<concept>
%<concept_id>10011007.10011006.10011008</concept_id>
%<concept_desc>Software and its engineering~General programming languages</concept_desc>
%<concept_significance>500</concept_significance>
%</concept>
%<concept>
%<concept_id>10003456.10003457.10003521.10003525</concept_id>
%<concept_desc>Social and professional topics~History of programming languages</concept_desc>
%<concept_significance>300</concept_significance>
%</concept>
%</ccs2012>
%\end{CCSXML}

%\ccsdesc[500]{Software and its engineering~General programming languages}
%\ccsdesc[300]{Social and professional topics~History of programming languages}
%% End of generated code


%% Keywords
%% comma separated list
%\keywords{compilers, security}  %% \keywords are mandatory in final camera-ready submission


%% \maketitle
%% Note: \maketitle command must come after title commands, author
%% commands, abstract environment, Computing Classification System
%% environment and commands, and keywords command.
\maketitle

\linenumbers

\section{Introduction}

% a recent theory of secure compilation is robust ...

Compilers translate programs from a source to a target programming language.
A secure compilation chain preserves source level properties at the target level.
Different such preservation criteria for compilers exist.

Robust Compilation~\cite{patrignani18,abate2019,patrignani19,patrignani21} is a set of criteria for secure compilers that have become widely accepted.
Informally, a compiler is robustly preserving a property if source and target program linked with an arbitrary source and target context, respectively, satisfy that property.
Hereby, the target program is the compiled version of the source program.

Even though there exist robust compilers, they are far from practical.
Real-world compilers consist of several smaller compilers that are composed with each other in a certain way.
A prominent example would be any compiler based on the LLVM toolchain~\cite{lattner04}, whose optimisation pipeline consists of many passes, which one can view as independent compilers composed to achieve speedups.
Also, any lowering steps, such as from a frontend language to LLVM IR and subsequently to machine Assembly, are intermixed compilers.
To the best of our knowledge, current work on robust compilation does not discuss the preservation of source-level properties for compilation chains.

This paper investigates how different compiler compositions preserve hyperproperties, given that the compilers involved in the composition fulfil certain assumptions.
To reason about hyperproperty preservation, we will look at the lattice of classes of hyperproperties, omitted in this paper.
Within the lattice of such classes, we examine whether at least the least upper bound is preserved by our chosen compositions.
We present a preliminary result: We show that the order of optimisations in a robustly preserving compilation pipeline does not matter for property preservation.
We conclude with a discussion on what happens if compilers in the chain do not robustly preserve properties of interest.

% optimisations might not preserve the prop

\section{Compositionality}
% to reason about compilers, we need to ....
In this work, programs are elements of $\partials$, the set of partial programs of a given programming language.
A compiler is a partial function $\stcomp{\bullet}$ from programs $\src{\partials}$ of some source language $\S$ to programs $\trg{\partials}$ of some target language $\T$.
To reason about the preservation of properties present in some $\S$ program, we define in \Cref{def:rtp} the criterion a robustly preserving compiler should fulfil.
We extend existing theory on hyperproperties~\cite{clarkson08} by introducing classes, which are sets of hyperproperties.
If all hyperproperties from a class $\cC$ are satisfied by some program $p$ that is linked with an arbitrary context, then we write $\rsat{p}{\cC}$.
Accordingly, for some $\Pi\in\cC$, we also write $\rsat{p}{\Pi}$ whenever $p$ robustly satisfies $\Pi$.

\begin{definition}[Robust Compilation]\label{def:rtp}
  For a given class $\cC$, a compiler from languages $\S$ to $\T$ robustly preserves $\cC$ ($\rtp{\stcomp{\bullet}}{\cC}$) iff
  $$
  \forall\Pi\in\cC,\forall\src{p}\in\src{\partials},\rsat{\src{p}}{\Pi}\implies\rsat{\stcomp{\src{p}}}{\Pi}
  $$
\end{definition}
\noindent
%So, given a hyperproperty $\Pi$ from some class $\cC$ and a source program $\src{p}$ that robustly satisfies $\Pi$ ($\rsat{\src{p}}{\Pi}$), the compiled program $\stcomp{\src{p}}$ also needs to robustly satisfy $\Pi$.
The intuition of \Cref{def:rtp} is as follows: If the programmer makes certain assumptions on what a program does, these assumptions should also hold for the compiled program.

In practice, (robust) compilers are composed of numerous others.
Therefore, we now investigate their compositionality.

\subsection{Simple Compositionality}
We first consider function composition, i.e.\ plugging the result of one compiler into another one.
Such pipelines happen when optimising source code (so, at the level of a suitable intermediate representation), but also on a higher level:
Consider as an example a typical $\src{TypeScript}$ compilation pipeline.
First, it translates $\src{TypeScript}$ code to $\irl{JavaScript}$, which V8 compiles to $\trg{Ignition\ bytecode}$.

\begin{definition}[Sequential Composition of Compilers]
  Given two compilers $\sicomp{\bullet}$ and $\itcomp{\bullet}$, their sequential composition is $\sitcomp{\bullet}=\itcompN{\sicomp{\bullet}}$.
\end{definition}
Now, assuming that two compilers preserve certain classes, we know that their sequential composition preserves the least upper bound; the set intersection of those classes:
\begin{lemma}[Sequential Composition with RTP]\label{lem:seqcompo}
  Given $\rtp{\sicomp{\bullet}}{\cC_{1}}$ and $\rtp{\itcomp{\bullet}}{\cC_{2}}$, then $\rtp{\sitcomp{\bullet}}{\cC_{1}\cap\cC_{2}}$.
\end{lemma}
Using an inductive argument, \Cref{lem:seqcompo} generalises to $n$ robust compilers, each preserving one of $n$ classes.
To do so, one has to generalise the composition of two robust compilers to a set of $n$ robust compilers.

We now consider a compiler that invokes two other compilers.
$\src{HTML}$, $\irl{CSS}$, and JavaScript are the most obvious example of such a composition.
One writes down some code of any of these three languages embedded in the same file, but different compiler toolchains process them.

\begin{definition}[Upper Composition]
  Given two compilers $\stcomp{\bullet}$ and $\itcomp{\bullet}$, their upper composition is

  $$\uhcsitcomp{\bullet}=\lambda p.\begin{cases}\stcomp{p} &\text{if }p\in\src{\partials}\\
                                                \itcomp{p} &\text{if }p\in\irl{\partials}\end{cases}$$
\end{definition}
We can derive a similar result to \Cref{lem:seqcompo} here, too:
\begin{lemma}[Upper Composition with RC]\label{lem:useqcompo}
  Given $\rtp{\stcomp{\bullet}}{\cC_{1}}$ and $\rtp{\itcomp{\bullet}}{\cC_{2}}$, then $\rtp{\uhcsitcomp{\bullet}}{\cC_{1}\cap\cC_{2}}$.
\end{lemma}
\Cref{lem:useqcompo} also generalises inductively to a number of compilers and classes.

With the same idea, we define a dual composition that goes from a single source language to multiple target languages.
$\src{RubyOnRails}$ is a framework where the processed code is emitted to different target languages at once, in this case, $\trg{HTML}$ and $\irl{JavaScript}$.
\begin{definition}[Lower Composition]
  Given two compilers $\stcomp{\bullet}$ and $\sicomp{\bullet}$, their lower composition is $\lhcsitcomp{\bullet}$.
\end{definition}

\begin{lemma}[Lower Composition with RC]
  Given $\rtp{\stcomp{\bullet}}{\cC_{1}}$ and $\rtp{\sicomp{\bullet}}{\cC_{2}}$, then $\rtp{\lhcsitcomp{\bullet}}{\cC_{1}\cap\cC_{2}}$.
\end{lemma}

%\MP{Confusing and possibly wrong}
%Using the upper and lower composition, we may end up with a diamond situation, which the following lemma describes.
%Especially from a security researcher perspective, the diamond lemma is attractive as it says that there is no harm to prove compiler passes robust property preserving in a modular way.
%That is, consider some program instrumented against SPECTRE v1 attacks and, in parallel to that, against SPECTRE v4.
%If the compiler instrumentation for v1 does not violate v4, the lemma tells us that combining both instrumentations in some way yields an instrumentation that protects against both v1 and v4.

%\begin{lemma}[Diamond]\label{lem:diamond}
%  Given $\rtp{\lhcsiocomp{\bullet}}{\cC_{1}}$ and $\rtp{\uhciotcomp{\bullet}}{\cC_{2}}$ with $\stcomp{\bullet} = \lambda\src{p}.\uhciotcomp{\lhcsiocomp{p}}$, then $\rtp{\stcomp{\bullet}}{\cC_{1}\cap\cC_{2}}$.
%\end{lemma}

The following free theorem (\Cref{lem:swappable}) is a direct consequence of \Cref{lem:seqcompo} where the involved compilers' input and output are both partial programs in the same language.
Given that some compiler passes are robustly preserving properties, we can combine them in an arbitrary order and preserve the same least upper bound.
A compiler's pipeline ordering is difficult and often hand-tuned.
The lemma allows us to not care about the particular order of optimisations regarding their robust property preservation.
So, the compiler developer is free to swap passes around.
\begin{lemma}[Swappable]\label{lem:swappable}
  Given $\rtp{\ttcomp{\bullet}_{(1)}}{\cC_{1}}$ and $\rtp{\ttcomp{\bullet}_{(2)}}{\cC_{2}}$, then $\rtp{\ttcompN{\ttcomp{\bullet}_{(2)}}_{(1)}}{\cC_{1}\cap\cC_{2}}$ and $\rtp{\ttcompN{\ttcomp{\bullet}_{(1)}}_{(2)}}{\cC_{1}\cap\cC_{2}}$.
\end{lemma}

However, in practice, compiler passes are not necessarily robustly preserving.
Consider any stereotypical compilation pipeline.
The security researcher has a strong interest to ensure that properties at the source level are preserved at the target level.
Thus, if source programs robustly satisfy some property, so should the target.
However, it might not be necessary for compilation passes from one intermediate representation to the other to preserve properties robustly since compiler intermediate representations are outside the considered attack vector.
So, there might be some weaker property a pass has to satisfy in order to render the whole compilation pipeline secure.

\subsection{Advanced Compositionality}
Consider the following C code snippet that performs an infinite loop if an invalid pointer is given:
\begin{lstlisting}[language=c]
int something(int* ptr) {
  while(!ptr);
  return *ptr;
}
\end{lstlisting}
Compiling such code with optimisations turned on yields an x86-program where the potentially infinite loop has been removed:
\begin{lstlisting}[language={[x86masm]Assembler}]
something(int*):
  mov eax, DWORD PTR [rdi]
  ret
\end{lstlisting}
Upon calling this function with an invalid pointer, we now have an attack to violate memory safety, which did not work before; the check has been completely eliminated.

To prevent such issues, a common approach for ensuring memory safety is to extend the source language~\cite{tarditi2018,sammler21}.
But, this is not always desirable, since source language extensions imply that existing programs might need a rewrite.
Instrumentation passes \textit{enforce} memory safety by adding dynamic checks to the program and crashing appropriately, thus leaving the features of the source language untouched.
There exist several memory-safety instrumentations, both for target level~\cite{watson15,aurajo16,vassena19,kouwe17} and source level~\cite{nagarakatte10,akritidis09,rigger17}.
So, even though the programmer has written a memory-insecure program, we might still be interested in a memory-safe binary.

We plan to extend our work with code instrumentations, which \textit{enforce} classes of trace hyperproperties.
A sketch of the theory is as follows.

\begin{definition}[Secure Instrumentation for Preserving $\cC$]\label{def:secure-instrumentation}
  A secure instrumentation with respect to some class $\cC$ enforces hyperproperties described by some class $\cC'$ without violating $\cC$-satisfying programs.
  We write $\sinstr{\stcomp{\bullet}}{\cC'}{\cC}$.
\end{definition}
Using this, we firstly want to inspect an insecure compilation chain from e.g.\ memory-safe $\src{Rust}$ to optimised, insecure $\irl{C}$, to memory-safe $\trg{CheckedC}$:
\begin{example}[Enforcement may preserve...]
  Given classes $\cC_{1},\cC_{2}$ and compilers $\sicomp{\bullet}$,$\itcomp{\bullet}$, we assume:

  \begin{itemize}
  \item $\rtp{\sicomp{\bullet}}{\cC_{1}}$
  \item $\sinstr{\itcomp{\bullet}}{\cC_{2}}{\cC_{1}}$
  \end{itemize}
\noindent
  Then, $\rtp{\sitcomp{\bullet}}{\cC_{1}\cup\cC_{2}}$.
\end{example}

Likewise, running a compiler that does not respect e.g.\ memory-safety after a memory-safety instrumentation nullifies the preservation of it:
\begin{example}[...but, order matters!]
  Given classes $\cC_{1},\cC_{2}$ and compilers $\sicomp{\bullet}$,$\itcomp{\bullet}$, we assume:

  \begin{itemize}
  \item $\sinstr{\sicomp{\bullet}}{\cC_{2}}{\cC_{1}}$
  \item $\rtp{\itcomp{\bullet}}{\cC_{1}}$
  \end{itemize}
\noindent
  Then, $\rtp{\sitcomp{\bullet}}{\cC_{1}}$.
\end{example}

We also intend to study property-free characterisations of the presented material.
Another area is its specialisation to specific classes, such as $\cHSafety$, and subsets thereof.

%
% use british english!
%
% uppercase after semicolon
%

%% Acknowledgments
%\begin{acks}                            %% acks environment is optional
%                                        %% contents suppressed with 'anonymous'
%  %% Commands \grantsponsor{<sponsorID>}{<name>}{<url>} and
%  %% \grantnum[<url>]{<sponsorID>}{<number>} should be used to
%  %% acknowledge financial support and will be used by metadata
%  %% extraction tools.
%  This material is based upon work supported by the
%  \grantsponsor{GS100000001}{National Science
%    Foundation}{http://dx.doi.org/10.13039/100000001} under Grant
%  No.~\grantnum{GS100000001}{nnnnnnn} and Grant
%  No.~\grantnum{GS100000001}{mmmmmmm}.  Any opinions, findings, and
%  conclusions or recommendations expressed in this material are those
%  of the author and do not necessarily reflect the views of the
%  National Science Foundation.
%\end{acks}


\newpage

%% Bibliography
\bibliography{library}


%% Appendix
%\appendix
%\section{Appendix}

%Text of appendix \ldots

\end{document}
